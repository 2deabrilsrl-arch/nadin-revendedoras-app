generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  password       String
  name           String
  dni            String          @unique
  telefono       String
  handle         String          @unique
  margen         Float           @default(60)
  cbu            String?
  alias          String?
  cvu            String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  //  CAMPOS DE PERFIL COMPLETO
  profilePhoto   String?         // URL de la foto de perfil
  bio            String?         // Biograf铆a/descripci贸n corta
  
  //  REDES SOCIALES (todas opcionales)
  instagram      String?
  facebook       String?
  tiktok         String?
  whatsappBusiness String?
  linkedin       String?
  twitter        String?
  youtube        String?
  website        String?
  
  // Relaciones existentes
  pedidos        Pedido[]
  consolidaciones Consolidacion[]
  
  //  Relaciones de Gamificaci贸n
  badges         UserBadge[]
  level          UserLevel?
  points         Point[]
  rankings       Ranking[]
}

model Pedido {
  id        String   @id @default(cuid())
  userId    String
  cliente   String
  telefono  String?
  nota      String?
  estado    String   @default("pendiente")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Estados del pedido (log铆stica)
  orderStatus String   @default("pending")
  
  // Estados de pago
  paidToNadin    Boolean  @default(false)
  paidByClient   Boolean  @default(false)
  
  // Fechas de cambio de estado
  sentToNadinAt      DateTime?
  receivedNadinAt    DateTime?
  sentToClientAt     DateTime?
  deliveredAt        DateTime?
  paidToNadinAt      DateTime?
  paidByClientAt     DateTime?
  
  user      User     @relation(fields: [userId], references: [id])
  lineas    Linea[]
  @@index([userId])
  @@index([estado])
  @@index([createdAt])
}

model Linea {
  id         String  @id @default(cuid())
  pedidoId   String
  productId  String
  variantId  String
  sku        String?
  brand      String?
  name       String
  talle      String?
  color      String?
  qty        Int
  mayorista  Float
  venta      Float
  pedido     Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  @@index([pedidoId])
  @@index([productId])
}

model Consolidacion {
  id              String   @id @default(cuid())
  userId          String
  pedidoIds       String
  formaPago       String
  tipoEnvio       String
  transporteNombre String?
  totalMayorista  Float
  totalVenta      Float
  ganancia        Float
  descuentoTotal  Float    @default(0)
  costoReal       Float?
  gananciaNeta    Float?
  csvPath         String?
  enviadoAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([enviadoAt])
}

model CatalogoCache {
  id          String   @id @default(cuid())
  productId   String   @unique
  data        String
  brand       String?
  category    String?
  sex         String?
  salesCount  Int      @default(0)
  updatedAt   DateTime @default(now())
  
  @@index([brand])
  @@index([sex])
  @@index([salesCount])
  @@index([updatedAt])
}

// ==========================================
//  GAMIFICACIN - TABLAS
// ==========================================

//  Medallas/Insignias del sistema
model Badge {
  id          String      @id @default(cuid())
  slug        String      @unique // "primera-venta", "10-ventas", etc.
  name        String      // "Primera Venta"
  description String      // "Realizaste tu primera venta"
  icon        String      // "" o nombre de icono
  category    String      // "ventas", "constancia", "especial"
  condition   String      // Condici贸n para desbloquear (JSON)
  points      Int         @default(0) // Puntos que otorga
  rarity      String      @default("common") // common, rare, epic, legendary
  createdAt   DateTime    @default(now())
  
  // Relaci贸n con usuarios que la tienen
  users       UserBadge[]
  
  @@index([category])
  @@index([rarity])
}

//  Medallas desbloqueadas por usuarios
model UserBadge {
  id          String   @id @default(cuid())
  userId      String
  badgeId     String
  unlockedAt  DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge       Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId])
  @@index([userId])
  @@index([unlockedAt])
}

//  Nivel del usuario
model UserLevel {
  id            String   @id @default(cuid())
  userId        String   @unique
  currentLevel  String   @default("bronce") // bronce, plata, oro, platino, diamante, leyenda
  currentXP     Int      @default(0) // Experiencia actual
  totalSales    Int      @default(0) // Total de ventas realizadas
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([currentLevel])
  @@index([totalSales])
}

//  Historial de puntos
model Point {
  id          String   @id @default(cuid())
  userId      String
  amount      Int      // Cantidad de puntos (+ ganados, - canjeados)
  reason      String   // "venta", "compartir", "completar-perfil", "canje-descuento"
  description String?  // Descripci贸n detallada
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
  @@index([reason])
}

//  Rankings
model Ranking {
  id          String   @id @default(cuid())
  userId      String
  period      String   // "monthly-2024-11", "yearly-2024", "all-time"
  category    String   // "ventas", "monto", "constancia"
  position    Int      // Posici贸n en el ranking
  value       Float    // Valor que determina la posici贸n (ej: total ventas)
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, period, category])
  @@index([period])
  @@index([category])
  @@index([position])
}
