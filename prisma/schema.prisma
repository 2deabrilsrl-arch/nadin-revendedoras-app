generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  password       String
  name           String
  dni            String          @unique
  telefono       String
  handle         String          @unique
  margen         Float           @default(60)
  cbu            String?
  alias          String?
  cvu            String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  // üÜï CAMPOS DE PERFIL COMPLETO
  profilePhoto   String?         // URL de la foto de perfil
  bio            String?         // Biograf√≠a/descripci√≥n corta
  
  // üÜï REDES SOCIALES (todas opcionales)
  instagram      String?
  facebook       String?
  tiktok         String?
  whatsappBusiness String?
  linkedin       String?
  twitter        String?
  youtube        String?
  website        String?
  
  // Relaciones existentes
  pedidos        Pedido[]
  consolidaciones Consolidacion[]
  
  // üéÆ Relaciones de Gamificaci√≥n
  badges         UserBadge[]
  level          UserLevel?
  points         Point[]
  rankings       Ranking[]
  brandSales     UserBrandSales[]
}

model Pedido {
  id        String   @id @default(cuid())
  userId    String
  cliente   String
  telefono  String?
  nota      String?
  estado    String   @default("pendiente")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Estados del pedido (log√≠stica)
  orderStatus String   @default("pending")
  
  // Estados de pago
  paidToNadin    Boolean  @default(false)
  paidByClient   Boolean  @default(false)
  
  // ‚ùå ELIMINADO: montoRealPagado (esto va en Consolidacion)
  
  // Fechas de cambio de estado
  sentToNadinAt      DateTime?
  receivedNadinAt    DateTime?
  sentToClientAt     DateTime?
  deliveredAt        DateTime?
  paidToNadinAt      DateTime?
  paidByClientAt     DateTime?
  
  user      User     @relation(fields: [userId], references: [id])
  lineas    Linea[]
  @@index([userId])
  @@index([estado])
  @@index([createdAt])
}

model Linea {
  id         String  @id @default(cuid())
  pedidoId   String
  productId  String
  variantId  String
  sku        String?
  brand      String?
  name       String
  talle      String?
  color      String?
  qty        Int
  mayorista  Float
  venta      Float
  pedido     Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  @@index([pedidoId])
  @@index([productId])
}

model Consolidacion {
  id              String   @id @default(cuid())
  userId          String
  pedidoIds       String   // JSON array de IDs de pedidos
  formaPago       String
  tipoEnvio       String
  transporteNombre String?
  totalMayorista  Float    // Costo mayorista total
  totalVenta      Float    // Total vendido a clientas
  ganancia        Float    // Ganancia estimada (venta - mayorista)
  descuentoTotal  Float    @default(0)
  
  // üí∞ GANANCIA REAL
  costoReal       Float?   // Lo que REALMENTE pagaste a Nadin
  gananciaNeta    Float?   // Ganancia real: (totalVenta - descuento) - costoReal
  
  csvPath         String?
  enviadoAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([enviadoAt])
}

model CatalogoCache {
  id          String   @id @default(cuid())
  productId   String   @unique
  data        String
  brand       String?
  category    String?
  sex         String?
  salesCount  Int      @default(0)
  updatedAt   DateTime @default(now())
  
  @@index([brand])
  @@index([sex])
  @@index([salesCount])
  @@index([updatedAt])
}

// ==========================================
// üéÆ GAMIFICACI√ìN - TABLAS
// ==========================================

// üèÖ Medallas/Insignias del sistema
model Badge {
  id          String      @id @default(cuid())
  slug        String      @unique // "primera-venta", "10-ventas", etc.
  name        String      // "Primera Venta"
  description String      // "Realizaste tu primera venta"
  icon        String      // "ü•â" o nombre de icono
  category    String      // "ventas", "constancia", "especial"
  condition   String      // Condici√≥n para desbloquear (JSON)
  points      Int         @default(0) // Puntos que otorga
  rarity      String      @default("common") // common, rare, epic, legendary
  createdAt   DateTime    @default(now())
  
  // Relaci√≥n con usuarios que la tienen
  users       UserBadge[]
  
  @@index([category])
  @@index([rarity])
}

// üèÖ Medallas desbloqueadas por usuarios
model UserBadge {
  id          String   @id @default(cuid())
  userId      String
  badgeId     String
  unlockedAt  DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge       Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId])
  @@index([userId])
  @@index([unlockedAt])
}

// üìä Nivel del usuario
model UserLevel {
  id            String   @id @default(cuid())
  userId        String   @unique
  currentLevel  String   @default("bronce") // bronce, plata, oro, platino, diamante, leyenda
  currentXP     Int      @default(0) // Experiencia actual
  totalSales    Int      @default(0) // Total de ventas realizadas
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([currentLevel])
  @@index([totalSales])
}

// üíé Historial de puntos
model Point {
  id          String   @id @default(cuid())
  userId      String
  amount      Int      // Cantidad de puntos (+ ganados, - canjeados)
  reason      String   // "venta", "compartir", "completar-perfil", "canje-descuento"
  description String?  // Descripci√≥n detallada
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
  @@index([reason])
}

// üèÜ Rankings
model Ranking {
  id          String   @id @default(cuid())
  userId      String
  period      String   // "monthly-2024-11", "yearly-2024", "all-time"
  category    String   // "ventas", "monto", "constancia"
  position    Int      // Posici√≥n en el ranking
  value       Float    // Valor que determina la posici√≥n (ej: total ventas)
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, period, category])
  @@index([period])
  @@index([category])
  @@index([position])
}

// ==========================================
// üéñÔ∏è EMBAJADORAS DE MARCAS
// ==========================================

// üè∑Ô∏è Marcas participantes en el programa de embajadoras
model BrandAmbassador {
  id          String   @id @default(cuid())
  brandSlug   String   @unique  // "besame", "cocot", "promise", etc.
  brandName   String              // "B√©same", "Cocot", "Promise"
  logoUrl     String?             // URL del logo (opcional por ahora)
  logoEmoji   String   @default("üè∑Ô∏è") // Emoji temporal mientras no hay logo
  isActive    Boolean  @default(true)  // Para activar/desactivar marcas
  createdAt   DateTime @default(now())
  
  @@index([isActive])
  @@index([brandSlug])
}

// üìä Tracking de ventas por marca por usuario
model UserBrandSales {
  id          String   @id @default(cuid())
  userId      String
  brandSlug   String   // "besame", "cocot", etc.
  salesCount  Int      @default(0)  // Ventas completadas de esta marca
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, brandSlug])
  @@index([userId])
  @@index([brandSlug])
  @@index([salesCount])
}
